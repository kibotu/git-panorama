name: Deploy Dashboard Snapshot

on:
  # Run on push to main
  push:
    branches: [ main ]
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      time_range:
        description: 'Time range for dashboard (e.g., now-30d, now-90d, now-1y)'
        required: false
        default: 'now-30d'
  
  # Run weekly on Monday at 2 AM UTC
  schedule:
    - cron: '0 2 * * 1'

jobs:
  generate-and-deploy:
    name: Generate Dashboard Snapshot
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for GitHub Pages deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git analysis
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          uv pip install -r requirements.txt --system
          uv pip install requests --system
      
      - name: Start Docker services
        run: docker compose up -d
      
      - name: Wait for services
        run: |
          timeout 120 bash -c 'until curl -s http://localhost:9200/_cluster/health > /dev/null; do echo "Waiting for Elasticsearch..."; sleep 5; done'
          timeout 60 bash -c 'until curl -s http://localhost:3000/api/health > /dev/null; do echo "Waiting for Grafana..."; sleep 5; done'
          echo "âœ“ Services are ready"
      
      - name: Setup Elasticsearch indices
        run: |
          chmod +x scripts/setup-elasticsearch-indices.sh
          ./scripts/setup-elasticsearch-indices.sh
      
      - name: Create demo data
        run: |
          # Create a test repository with commits
          mkdir -p repositories/demo-repo
          cd repositories/demo-repo
          git init
          git config user.email "demo@example.com"
          git config user.name "Demo User"
          
          # Create multiple commits over time
          echo "# Demo Project" > README.md
          git add README.md
          git commit -m "Initial commit" --date="2024-01-01 10:00:00"
          
          echo "console.log('Hello World');" > app.js
          git add app.js
          git commit -m "Add app.js" --date="2024-01-15 14:30:00"
          
          echo "export default class Demo {}" > demo.ts
          git add demo.ts
          git commit -m "Add TypeScript module" --date="2024-02-01 09:15:00"
          
          echo "test('demo', () => expect(true).toBe(true));" > demo.test.js
          git add demo.test.js
          git commit -m "Add tests" --date="2024-02-15 16:45:00"
          
          echo "Updated README" >> README.md
          git add README.md
          git commit -m "Update README" --date="2024-03-01 11:20:00"
          
          cd ../..
      
      - name: Create demo config
        run: |
          cat > config-demo.yaml << 'EOF'
          email_mapping:
            "Demo User":
              - "demo@example.com"
          
          repositories:
            base_directory: "./repositories"
            repositories_to_analyze:
              - "demo-repo"
            repository_urls: []
          
          analysis:
            start_date: ""
            end_date: ""
            all_branches: true
            exclude_merge_commits: true
            output_directory: "./git-stats"
          
          exclusions:
            patterns: []
            always_include: []
            repository_specific: {}
          
          elasticsearch:
            host: "localhost"
            port: 9200
            commit_index: "git-commits"
            bulk_batch_size: 1000
          
          parallelization:
            max_workers: 1
          EOF
      
      - name: Run analysis
        run: python3 scripts/analyze_git_commits.py config-demo.yaml
      
      - name: Upload to Elasticsearch
        run: |
          chmod +x scripts/upload-to-elasticsearch.sh
          CONFIG_FILE=config-demo.yaml ./scripts/upload-to-elasticsearch.sh
      
      - name: Verify data in Elasticsearch
        run: |
          sleep 5
          echo "=== Checking commit count ==="
          COMMIT_COUNT=$(curl -s "http://localhost:9200/git-commits/_count" | jq -r '.count')
          echo "Found $COMMIT_COUNT commits"
          
          if [ "$COMMIT_COUNT" -lt 1 ]; then
            echo "Warning: No commits found in Elasticsearch"
            echo "Dashboard will be empty, but we'll continue to demonstrate the setup"
          fi
      
      - name: Export Grafana dashboard
        run: |
          chmod +x scripts/export-grafana-dashboard.py
          TIME_RANGE="${{ github.event.inputs.time_range || 'now-1y' }}"
          python3 scripts/export-grafana-dashboard.py \
            --grafana-url http://localhost:3000 \
            --username admin \
            --password admin \
            --dashboard-uid git-stats-repository \
            --output-dir docs \
            --time-from "$TIME_RANGE" \
            --time-to now \
            --wait-timeout 60
      
      - name: Add .nojekyll file
        run: |
          # Prevent GitHub Pages from processing with Jekyll
          touch docs/.nojekyll
      
      - name: Create README for docs
        run: |
          cat > docs/README.md << 'EOF'
          # Git Panorama Dashboard Snapshot
          
          This is an automatically generated static snapshot of the Git Panorama Grafana dashboard.
          
          **View the dashboard:** [index.html](./index.html)
          
          ## About
          
          This snapshot is automatically generated and deployed via GitHub Actions.
          It provides a static view of repository statistics and commit activity.
          
          For the full interactive experience with filtering and drill-down capabilities,
          please run Git Panorama locally or on your own infrastructure.
          
          ## Updates
          
          This dashboard is automatically updated:
          - On every push to the main branch
          - Weekly on Mondays at 2 AM UTC
          - Manually via workflow dispatch
          
          Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
      
      - name: List generated files
        run: |
          echo "=== Generated files ==="
          ls -lah docs/
          echo ""
          echo "=== Generated images ==="
          ls -lah docs/images/ || echo "No images directory"
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy dashboard snapshot'
      
      - name: Show deployment URL
        run: |
          echo "=========================================="
          echo "Dashboard deployed to GitHub Pages!"
          echo ""
          echo "URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "Note: It may take a few minutes for GitHub Pages to update."
          echo "=========================================="
      
      - name: Stop services
        if: always()
        run: docker compose down -v

